REL_MANAGER=function(){return{base_app_del:function(e,t,a,s){art.dialog({title:gettext("删除确认"),width:300,icon:"question",lock:!0,content:"<div class='t_s14'>"+gettext("您确定要删除应用")+"“"+t+"”?</div>",ok:function(){$.post(a,function(e){e.result?(art.dialog({id:"bktips"}).close(),window.location.href=s):art.dialog({id:"bktips",title:gettext("温馨提示"),width:340,icon:"error",lock:!0,content:e.msg,ok:function(){},okVal:gettext("关闭")})},"json")},cancel:function(){},okVal:gettext("确定"),cancelVal:gettext("取消")})},app_del:function(e,t){var a=BLUEKING.config.paas_host()+"release/delete/"+t+"/",s=BLUEKING.config.paas_host()+"app/list/";REL_MANAGER.base_app_del(e,t,a,s)},saas_app_del:function(e,t){var a=BLUEKING.config.paas_host()+"saas/delete/"+t+"/",s=BLUEKING.config.paas_host()+"saas/list/";REL_MANAGER.base_app_del(e,t,a,s)},tpapp_del:function(e,t){var a=BLUEKING.config.paas_host()+"release/delete/"+t+"/",s=BLUEKING.config.paas_host()+"tpapp/list/";REL_MANAGER.base_app_del(e,t,a,s)},app_test:function(e,t){if($(e).hasClass("btn-disabled"))return!1;var a=$("#checkout_target").val();if(void 0!==a&&a.length<1)return art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:gettext("部署分支/Tag不能为空")}).time(2),!1;var s=$("#is_use_celery").attr("checked"),o=$("#is_use_celery_beat").attr("checked"),l={is_use_celery:s,is_use_celery_beat:o,checkout_target:a},n=BLUEKING.config.paas_host()+"release/test/"+t+"/";REL_MANAGER._app_release_task(e,t,n,l,1)},app_online:function(e,t){if($(e).hasClass("btn-disabled"))return!1;var a=$("#is_tips").attr("checked"),s=a?"1":"0",o=$("#features").val(),l=$("#bugs").val(),n=[];if($.each($("input[name='servers']:checked"),function(){n.push($(this).val())}),n.length<1)return art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:gettext("请至少选择一台服务器")}).time(2),!1;var i=n.join(","),r={is_tips:s,features:o,bugs:l,servers:i},_=BLUEKING.config.paas_host()+"release/online/"+t+"/";REL_MANAGER._app_release_task(e,t,_,r,2)},app_outline:function(e,t){var a=$("#t_check").attr("checked"),s=$("#o_check").attr("checked");if($("#outline_form_error").html("").hide(),$(e).hasClass("btn-disabled"))return!1;if(!a&&!s)return $("#outline_form_error").text(gettext("请选择下架环境！")).show(),!1;var o="all";a&&s?o="all":a?o="test":s&&(o="prod");var l={mode:o},n=BLUEKING.config.paas_host()+"release/outline/"+t+"/";REL_MANAGER._app_release_task(e,t,n,l,3)},_app_release_task:function(e,t,a,s,o){1==o?$("#release_msg_test").parent().parent().hide():2==o?$("#release_msg_pro").parent().parent().hide():$("#release_msg_outline").parent().parent().hide();var l="",n="";n=1==o?gettext("上线部署"):2==o?gettext("测试部署"):gettext("下架"),l='<div class="ml30"><span style="font-size: 16px;margin-left:30px;"><i class="icon-loading mr10"></i>'+gettext("正在提交")+n+gettext("请求，请稍后...")+"</div>",$("#release-flow-before").hide(),$("#tips_info").html(""),$("#tips_info").show(),$("#deploy_input").hide(),$("#release-flow-before").html(l),$("#release-flow-before").show(),$.post(a,{form_data:JSON.stringify(s)},function(a){if(a.result){if(a.result){a.event_id;REL_MANAGER._app_to_poll_task(e,t,a,o,s)}}else{REL_MANAGER.back();var l="";l=1==o?gettext("测试部署"):2==o?gettext("上线部署"):gettext("下架");var n="<p><span class='icon forbid'></span><strong class='fail'>"+l+gettext("操作执行失败，错误详情：")+"</strong></span><div class='streamline'> <pre>"+a.msg+"</pre></div>";1==o?$("#release_msg_test").html(n).parent().parent().show():2==o?$("#release_msg_pro").html(n).parent().parent().show():$("#release_msg_outline").html(n).parent().parent().show(),$("button[n_btn=deploy]").parent().find("span[n_m=run]").remove(),$("button[n_btn=deploy]").show(),$("button[n_btn=deploy]").removeAttr("disabled"),$("button[n_btn=saas_deploy]").removeAttr("disabled")}},"json")},confirm_saas_app_offline:function(e,t,a){art.dialog({title:gettext("温馨提示"),width:340,icon:"warning",lock:!0,content:gettext("<span>您确认下架该应用吗?<br><br>下架后用户将无法访问该应用<br>但应用的数据库依然保留</span>"),ok:function(){var s={mode:a},o=BLUEKING.config.paas_host()+"release/outline/"+t+"/";$(e).attr({disabled:"disabled"}),REL_MANAGER._app_release_task(e,t,o,s,3)},okVal:gettext("确认"),cancelVal:gettext("取消"),cancel:function(){}})},confirm_saas_app_online:function(e,t,a,s,o){if(a&&"0"!=a&&"1"!=a){var l=$("#version_info").attr("current_version"),n=$("#version_info").attr("online_version");art.dialog({title:gettext("温馨提示"),width:400,icon:"warning",lock:!0,content:gettext("<span>您确认重新部署该应用吗?<br><br>当前环境运行版本：")+n+gettext("<br>您要部署的版本：")+l+"</span>",ok:function(){REL_MANAGER.saas_app_online(e,t,s,o)},okVal:gettext("确认"),cancelVal:gettext("取消"),cancel:function(){}})}else REL_MANAGER.saas_app_online(e,t,s,o)},saas_app_online:function(e,t,a,s){$(e).attr({disabled:"disabled"});var o=BLUEKING.config.paas_host()+"saas/release/online/"+t+"/";tips_msg='<div class="ml30"><span style="font-size: 16px;margin-left:30px;"><i class="icon-loading mr10"></i>'+gettext("正在提交部署请求，请稍后...")+"</div>",$("#release-flow-before").hide(),$("#tips_info").html(""),$("#tips_info").show(),$("#deploy_input").hide(),$("#release-flow-before").html(tips_msg),$("#release-flow-before").show(),$("#release_msg_pro").parent().parent().hide(),$.post(o,{mode:a,servers:s},function(t){if(t.result){if(t.result){var a=(t.event_id,t.app_code);REL_MANAGER._app_to_poll_task(e,a,t,2,{})}}else{REL_MANAGER.back();var s="<p><span class='icon forbid'></span><strong class='fail'>"+gettext("部署操作执行失败，错误详情：")+"</strong></span><div class='streamline'> <pre>"+t.msg+"</pre></div>";$("#release_msg_pro").html(s).parent().parent().show(),$("#saas_app_online").removeAttr("disabled")}},"json")},tpapp_release_task:function(e,t,a,s){var o="";if("online"==a)o=gettext("部署");else{if("offline"!=a)return!1;o=gettext("下架")}$(e).attr({disabled:"disabled"}),$("#release_tips").html('<img alt="loadding" src="'+s+'img/loading_2_24x24.gif" style="width: 16px;height: 16px;"><span class="ml5">'+gettext("正在")+o+gettext("中，请耐心等待</span>"));var l=BLUEKING.config.paas_host()+"tpapp/release/task_excute/"+t+"/";$.post(l,{mode:a},function(a){a.result?($("#release_tips").html('<span class="glyphicon glyphicon-ok-circle" aria-hidden="true" style="color: #5cb85c;"></span><span class="ml5">'+o+gettext("成功")+"</span>"),BASE_APP.refresh_tpapp_status(t)):($("#release_tips").html('<span class="glyphicon glyphicon-remove-circle" aria-hidden="true" style="color: red"></span><span class="ml5">'+o+gettext("失败，原因")+"："+a.message+"</span>"),$(e).removeAttr("disabled"))},"json")},_app_to_poll_task:function(e,t,a,s,o){var l="";l=BLUEKING.config.paas_host()+"release/get_app_poll_task/"+t+"/",$.get(l,{event_id:a.event_id,app_state:s},function(l){data=l.data,html_data=data.html,$("#release-flow").html(html_data),!1===$("#release-flow-before").is(":hidden")&&$("#release-flow-before").hide(),$("#release-flow").is(":hidden")&&$("#release-flow").show(),0===data.status?REL_MANAGER._app_operate_fail(e,t,data,s,o):1==data.status?REL_MANAGER._app_operate_success(e,t,data,s,o):REL_MANAGER.start_or_stop_loop(1,e,t,a,s,o)},"json")},start_or_stop_loop:function(e,t,a,s,o,l){1==e?loop_event=window.setTimeout(function(){REL_MANAGER._app_to_poll_task(t,a,s,o,l)},2e3):"undefined"!=typeof loop_event&&clearTimeout(loop_event)},_app_operate_fail:function(e,t,a,s,o){$("button[n_btn=saas_deploy]").removeClass("disabled"),$("button[n_btn=saas_deploy]").removeAttr("disabled")},_app_operate_success:function(e,t,a,s,o){if($("#deploy_apply div[apply]").hide(),$("#error_dev").html(""),$("#app_del").remove(),REL_MANAGER.refresh_app_state(e,s,a,o),BASE_APP.refresh_app_status(t),$("textarea[name=features], textarea[name=bugs]").val(""),$("#is_tips").removeAttr("checked"),$(".appstate").html(""),$("button[n_btn=deploy]").removeClass("disabled"),$("button[n_btn=deploy]").removeAttr("disabled"),1==s)REL_MANAGER._modify_online_state("show"),REL_MANAGER._modify_outline_state("show");else if(2==s)REL_MANAGER._modify_online_state("hide",!1,'<span aria-hidden="true" class="glyphicon glyphicon-info-sign"></span>'+gettext("应用已上线，请重新测试部署后，再执行正式部署操作！")),REL_MANAGER._modify_outline_state("show");else{var l=o.mode,n=$("#t_check"),i=$("#o_check");"all"==l?(n.attr("checked",!1),n.attr("disabled",!0),i.attr("checked",!1),i.attr("disabled",!0)):"test"==l?(n.attr("checked",!1),n.attr("disabled",!0)):"prod"==l&&(i.attr("checked",!1),i.attr("disabled",!0)),n.attr("disabled")&&i.attr("disabled")&&($(e).addClass("btn-disabled"),REL_MANAGER._modify_outline_state("hide")),"all"!=l&&"prod"!=l||REL_MANAGER._modify_online_state("hide",!1,'<span aria-hidden="true" class="glyphicon glyphicon-info-sign"></span>'+gettext("应用已下架，请您重新测试部署后，再进行正式部署操作！"))}},_modify_online_state:function(e,t,a){"hide"==e?(t||($("#deploy_tab li[data-id=online_form]").addClass("disabled_status"),$("#deploy_tab li[data-id=online_form] span").show(),$("#deploy_tab li[data-id=online_form] a").attr("title",gettext("请重新测试部署后，再进行正式部署！"))),$("#app_online, #create_new_ver").addClass("disabled"),$("#app_online").removeAttr("id"),$("#create_new_ver").removeAttr("id"),$("#online_form_error").html(a).show()):"show"==e&&($("#deploy_tab li[data-id=online_form]").removeClass("disabled_status"),$("#deploy_tab li[data-id=online_form] a").removeAttr("title"),$("#deploy_tab li[data-id=online_form] span").hide())},_modify_outline_state:function(e){"show"==e?($("#deploy_tab li[data-id=outline_form]").removeClass("disabled_status"),$("#deploy_tab li[data-id=outline_form] a").removeAttr("title"),$("#deploy_tab li[data-id=outline_form] span").hide()):"hide"==e&&($("#deploy_tab li[data-id=outline_form]").addClass("disabled_status"),$("#deploy_tab li[data-id=outline_form] a").attr("title",gettext("请测试部署后，再进行正式部署")),$("#deploy_tab li[data-id=outline_form] span").show())},refresh_app_state:function(e,t,a,s){if(1==t)$("#test_state").html('<a href="'+a.app_test_url+'" target="_blank"><span aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span>'+gettext("马上访问")+"</a>"),$("span[name_state=test]").text(gettext("正在运行")).removeClass("status_normal").addClass("status_success");else if(2==t)$("#pro_state").html('<a href="'+a.app_prod_url+'" target="_blank"><span aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span>'+gettext("马上访问")+"</a>"),$("span[name_state=pro]").text(gettext("正在运行")).removeClass("status_normal").addClass("status_success");else{var o=s.mode,l='<span class="glyphicon glyphicon-chevron-right ml40" style="color:#999;" data-toggle="tooltip" data-placement="right" title="'+gettext("应用未进行上线部署或者已经下架，访问入口关闭！")+'"></span>'+gettext("马上访问"),n='<span class="glyphicon glyphicon-chevron-right ml40" style="color:#999;" data-toggle="tooltip" data-placement="right" title="'+gettext("应用未进行测试部署或者已经下架，访问入口关闭！")+'"></span>'+gettext("马上访问");"test"!=o&&"all"!=o||($("#test_state").html(n),$("span[name_state=test]").text(gettext("已下架")).removeClass("status_success").addClass("status_normal")),"prod"!=o&&"all"!=o||($("#pro_state").html(l),$("span[name_state=pro]").text(gettext("已下架")).removeClass("status_success").addClass("status_normal"))}},back:function(){$("#release-flow-before").hide(),$("#release-flow").hide(),$("#detail_log").hide(),$("#detail_button").hide(),$("#detail_click").html(gettext("点击查看详情")),$("#tips_info").hide(),$("#deploy_input").show()},back_saas:function(e,t,a){var s="0";"prod"==a&&(s="1"),window.location.href="online"==t?BLUEKING.config.paas_host()+"saas/release/online/"+e+"/?tab="+s:BLUEKING.config.paas_host()+"saas/release/offline/"+e+"/?tab="+s},get_app_release_detail:function(){if($("#detail_log").is(":hidden")){$("#detail_log").show();var e=$("#detail_info")[0].scrollHeight;$("#detail_info").scrollTop(e),$("#detail_click").html(gettext("点击隐藏详情"))}else $("#detail_log").hide(),$("#detail_click").html(gettext("点击查看详情"))},refresh_roll:function(e,t,a,s,o){var l=BLUEKING.config.paas_host()+"release/get_last_release_record/"+e+"/";$.get(l,{},function(t){t.res&&REL_MANAGER._app_to_poll_task(null,e,t,o,{})},"json")},deploy_tab_show:function(e,t,a,s,o,l,n,i){var r=t;if(e.hasClass("disabled_status"));else{var _=e.attr("data-id"),d=BLUEKING.config.paas_host()+"release/get_deploy_page/"+_+"/"+a+"/";$("#"+_).html('<div style="text-align: center;margin-top:50px;opacity:0.2;filter:alpha(opacity=20);"><img src="'+i+'img/base/icon32_loading_light1e5b3a.gif"></div>'),$.get(d,function(e){$("#"+_).html(e),8!=s&&9!=s&&10!=s||r&&($("#release-flow-before").hide(),$("#tips_info").html(""),$("#deploy_input").hide(),REL_MANAGER.refresh_roll(a,s,o,l,n))}),$("#deploy_tab").find(".active").removeClass("active"),e.addClass("active"),$(".deploy_content").find("div[n_form]").hide(),$("#"+_).show()}return r},search_app_record:function(e,t){var a=BLUEKING.config.paas_host()+"release/get_app_record/"+e+"/"+t+"/";$.get(a,function(e){$("#record_list").html(e)})},search_tpapp_record:function(e,t){var a=BLUEKING.config.paas_host()+"tpapp/release/record_list/"+e+"/"+t+"/";$.get(a,function(e){$("#record_list").html(e)})},pub_record_show:function(e){var t=e.next("tr");if("detail"==t.attr("class")){var a=$(t).is(":hidden"),s=e.find("i");a?(e.next("tr").css("display",""),s.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up")):(e.next("tr").css("display","none"),s.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down"))}},check_unfinished_task:function(e){var t=BLUEKING.config.paas_host()+"release/check_unfinished_task/"+e+"/";$.get(t,function(e){})},check_use_celery:function(e){e||art.dialog({title:gettext("温馨提示"),width:340,icon:"warning",lock:!0,content:"<font style='color:red;'>"+gettext("您确认该应用没有使用celery吗？取消celery部署后，应用相关celery功能将不能使用！")+"</font>",ok:function(){$("#is_use_celery_beat").removeAttr("checked")},okVal:gettext("确认"),cancelVal:gettext("关闭"),cancel:function(){$("#is_use_celery").attr("checked","checked")}})},check_use_celery_beat:function(e){e?$("#is_use_celery").attr("checked","checked"):art.dialog({title:gettext("温馨提示"),width:340,icon:"warning",lock:!0,content:"<font style='color:red;'>"+gettext("取消“周期性任务”部署，已有周期性任务执行将会失效！您确认取消“周期性任务”部署吗？")+"</font>",ok:function(){},okVal:gettext("确认"),cancelVal:gettext("关闭"),cancel:function(){$("#is_use_celery_beat").attr("checked","checked")}})}}}();