function is_server_edit_status(){return $("#user_env_table tbody tr.env_edit_status").length>0&&(art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("不可同时修改多个服务信息，请先保存编辑中的服务信息")}).time(5),!0)}$(".env_add_btn").on("click",function(){if(is_server_edit_status())return!1;var t=['<tr class="env_record env_edit_status">','<input  type="hidden" class="server_id" disabled value="" />',"    <td>",'       <div class="env_key_box">','           <span class="s_id"></span>',"        </div>","    </td>","    <td>",'        <span class="server_token"></span>',"    </td>","    <td>",'       <input class="form-control server_ip"  value="" placeholder="'+gettext("请输入服务器IP")+'"/>',"    </td>","    <td>",'       <input type="number" min="1" max="65535" class="form-control server_port"  value="4245" placeholder="'+gettext("请输入Agent端口")+'"/>',"    </td>","    <td>",'       <input type="number" min="1" max="65535" class="form-control app_port"  value="8085" placeholder="'+gettext("请输入App服务端口")+'"/>',"    </td>","    <td>",'       <select class="form-control server_cate"  placeholder="'+gettext("请选择服务器类别")+'">','           <option value="tapp">'+gettext("测试服务器")+"</option>",'           <option value="app">'+gettext("正式服务器")+"</option>","       <select>","    </td>","    <td>",'        <span class="server_active">'+gettext("否")+"</span>","    </td>","    <td>",'    <button type="button" class="btn-info btn-xs env_save_btn">'+gettext("保存")+"</button>",'       <button type="button" class="btn-xs env_cancel_btn">'+gettext("取消")+"</button> ",'  <a href="###" title="'+gettext("编辑")+'" class="dev_env_opera env_edit_btn"><span aria-hidden="true" class="glyphicon glyphicon-edit"></span></a>','  <a href="###" title="'+gettext("删除")+'" class="dev_env_opera env_del_btn"><span aria-hidden="true" class="glyphicon glyphicon-remove-circle"></span></a>','  <a href="###" title="'+gettext("激活")+'" class="dev_env_opera env_active_btn"><span aria-hidden="true" class="glyphicon glyphicon-saved"></span></a>',"    </td>","</tr>"].join("");return $("#no_record_row").hide(),$("#user_env_table").append($(t)),!1}),$("#user_env_table").on("click",".env_save_btn",function(){var t=($(this),$(this).closest(".env_record")),e=t.find(".server_ip").val(),r=t.find(".server_port").val(),i=t.find(".app_port").val(),n=t.find(".server_cate").val(),a=t.find(".server_id").val();if(!e)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("请输入正确的IP地址")}).time(2),t.find(".server_ip").focus(),!1;if(!UTILS.isInt(r)||parseInt(r)<0||parseInt(r)>65535)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("请输入正确的Agent端口")}).time(2),t.find(".server_port").focus(),!1;if(!UTILS.isInt(i)||parseInt(i)<0||parseInt(i)>65535)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("请输入正确的App服务端口")}).time(2),t.find(".app_port").focus(),!1;if(!n)return art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("请选择服务器类别")}).time(2),t.find(".server_cate").focus(),!1;if(a){var s=BLUEKING.config.paas_host()+"engine/add_server_info/";$.post(s,{server_ip:e,server_port:r,app_port:i,server_cate:n,server_id:a},function(e,r){"success"==r?e.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:gettext("保存成功")}).time(1),t.find("input").attr("disabled","disabled"),t.find("select").attr("disabled","disabled"),t.removeClass("env_edit_status")):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:e.msg}):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("保存失败")})},"json")}else{var s=BLUEKING.config.paas_host()+"engine/add_server_info/";$.post(s,{server_ip:e,server_port:r,app_port:i,server_cate:n},function(e,r){"success"==r?e.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:gettext("添加成功")}).time(1),server_data=e.data,t.find(".server_id").val(server_data.server_id),t.find(".s_id").text(server_data.s_id),t.find(".server_token").text(server_data.token),t.find("input").attr("disabled","disabled"),t.find("select").attr("disabled","disabled"),t.removeClass("env_edit_status")):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:e.msg}).time(2):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:gettext("添加失败")}).time(2)},"json")}return!1}),$("#user_env_table").on("click",".env_edit_btn",function(){if(is_server_edit_status())return!1;var t=$(this).closest(".env_record");t.addClass("env_edit_status"),t.find("input").removeAttr("disabled"),t.find("select").removeAttr("disabled");var e=t.find(".server_ip").val(),r=t.find(".server_port").val(),i=t.find(".server_cate").val(),n=t.find(".app_port").val();return t.attr("data-old-ip",e),t.attr("data-old-port",r),t.attr("data-old-cate",i),t.attr("data-old-app-port",n),!1}),$("#user_env_table").on("click",".env_cancel_btn",function(){var t=$(this).closest(".env_record");t.removeClass("env_edit_status"),t.find("input").attr("disabled","disabled"),t.find("select").attr("disabled","disabled");var e=t.attr("data-old-ip"),r=t.attr("data-old-port"),i=t.attr("data-old-cate"),n=t.attr("data-old-app-port");if(e||r||i||n){t.find(".server_ip").val(e),t.find(".server_port").val(r),t.find(".server_cate").val(i);t.find(".app_port").val(n)}else t.remove();return!1}),$("#user_env_table").on("click",".env_del_btn",function(){var t=$(this).closest(".env_record"),e=t.find(".server_id").val(),r=t.find(".server_ip").val(),i=t.find(".server_port").val(),n=t.find(".server_active").attr("data");if(e){var a=BLUEKING.config.paas_host()+"engine/del_server_info/",s="<div class='t_s14'>"+gettext("您确定删除该服务器吗?")+"<br>IP : "+r+" , "+gettext("Agent端口")+" : "+i+"</div>",d=340;if("1"==n){var d=440;s+="<div style='color:red;margin-top: 10px;font-size: 14px;font-weight: bold;'>"+gettext("该服务器已经激活，删除后将不能在该机器上部署应用<br>请确认不再使用后再删除")+"</div>"}art.dialog({title:gettext("删除确认"),width:d,icon:"question",lock:!0,content:s,ok:function(){art.dialog({id:"bktips",width:300,icon:"warning",lock:!0,content:gettext("正在进行删除操作，请稍后...")}),$.post(a,{server_id:e},function(e){art.dialog({id:"bktips"}).close(),e.result?(art.dialog({id:"bktips",width:300,icon:"succeed",lock:!0,content:e.msg}).time(1),t.remove()):art.dialog({id:"bktips",width:300,icon:"error",lock:!0,content:e.msg})},"json")},cancel:function(){},okVal:gettext("确认删除"),cancelVal:gettext("取消")})}}),$("#user_env_table").on("click",".env_active_btn",function(){var t=$(this).closest(".env_active_btn"),e=$(this).closest(".env_record"),r=e.find(".server_id").val(),i=e.find(".server_ip").val(),n=e.find(".server_port").val();e.find(".server_active").attr("data");if(r){var a=BLUEKING.config.paas_host()+"engine/active_server/";gettext("正在检测服务器上的agent状态，请稍后...."),gettext("Agent端口");$.post(a,{server_id:r},function(r){art.dialog({id:"bktips"}).close(),r.result?(art.dialog({id:"bktips",icon:"succeed",lock:!0,content:r.msg}).time(1),e.find(".server_active").attr("data","1"),e.find(".server_active").text(gettext("是")),t.removeClass("env_active_btn").addClass("env_refresh_btn").html('<span aria-hidden="true" class="glyphicon  glyphicon-refresh"></span>')):art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.msg}).time(2)},"json")}}),$("#user_env_table").on("click",".env_refresh_btn",function(){var t=$(this).closest(".env_refresh_btn"),e=$(this).closest(".env_record"),r=e.find(".server_id").val(),i=e.find(".server_ip").val(),n=e.find(".server_port").val();e.find(".server_active").attr("data");if(r){var a=BLUEKING.config.paas_host()+"engine/refresh_server/",s="<div class='t_s14'>"+gettext("正在刷新服务器上的agent状态，请稍后....")+"<br><br>IP : "+i+" , "+gettext("Agent端口")+": "+n+"</div>";art.dialog({id:"bktips",width:450,height:200,icon:"face-smile",lock:!0,content:s}),$.post(a,{server_id:r},function(r){art.dialog({id:"bktips"}).close(),r.result?"0"==r.code?(art.dialog({id:"bktips",icon:"succeed",lock:!0,content:r.msg}).time(1),e.find(".server_active").attr("data","1"),e.find(".server_active").text(gettext("是")),t.removeClass("env_active_btn").addClass("env_refresh_btn").html('<span aria-hidden="true" class="glyphicon  glyphicon-refresh"></span>'),t.attr("title",gettext("刷新"))):(art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.msg}),e.find(".server_active").attr("data","0"),e.find(".server_active").text(gettext("否")),t.removeClass("env_refresh_btn").addClass("env_active_btn").html('<span aria-hidden="true" class="glyphicon glyphicon-saved"></span>'),t.attr("title",gettext("激活"))):art.dialog({id:"bktips",width:450,height:200,icon:"error",lock:!0,content:r.msg})},"json")}});