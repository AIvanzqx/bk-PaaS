$(function(){$.tablesorter.addParser({id:"req_count",is:function(e){return!1},format:function(e){return e=e.replace(",","").split("/"),e[e.length-1]},type:"numeric"}),Handlebars.registerHelper("counter",function(e){return e+1}),Handlebars.registerHelper("format_time",function(e,t){return!0===t&&(e*=1e3),moment(e).format("MM-DD HH:mm")}),Handlebars.registerHelper("add_commas",function(e){return void 0==e?"":ReplaceNumberWithCommas(e)});var e={time_since:"1h"},t=Backbone.Router.extend({routes:{"main/?:param":"main"},main:function(t){a.set_time_since(_.extend(e,deparam(t)).time_since),r.trigger("change")}}),i=new t,n=Backbone.Model.extend({time_seconds_map:{"1m":60,"10m":600,"30m":1800,"1h":3600,"24h":86400,"7d":604800},chart_interval_map:{"10m":"1m","30m":"1m","1h":"1m","24h":"1h","7d":"1d"},get_time_since_seconds:function(e){return this.time_seconds_map[e||this.attributes.time_since]},get_now_time_by_ms:function(){return 1e3*moment().unix()+moment().milliseconds()},get_mts_range:function(e){if(-1!==e.indexOf("custom:"))return l=e.slice(7).split("_"),{mts_start:l[0],mts_end:l[1]};var t=this.get_now_time_by_ms();return{mts_start:t-1e3*this.get_time_since_seconds(e),mts_end:t}},refresh_mts_range_to_now:function(){var e=this.get_now_time_by_ms(),t=e-(this.get("mts_end")-this.get("mts_start"));this.set({mts_start:t,mts_end:e})},set_time_since:function(e){var t=_.extend({time_since:e},this.get_mts_range(e));this.set(t)}}),a=new n(current_conf),s=Backbone.Model.extend(),r=new s,o=new s;r.set({boundary_time:"24h"}),o.set({type:"component",order:"availability_asc"});var m=Backbone.View.extend({el:"body",events:{"change #autorefresh-switch":function(e){$(e.target).is(":checked")?this.start_auto_refresh():this.stop_auto_refresh()}},initialize:function(){},start_auto_refresh:function(){this.interval_var=setInterval(function(){a.refresh_mts_range_to_now(),r.trigger("change")},6e4)},stop_auto_refresh:function(){clearInterval(this.interval_var)}}),c=Backbone.View.extend({el:"body",events:{"click #selector-boundary-time button":function(e){r.set({boundary_time:$(e.target).attr("value")})}},initialize:function(){this.listenTo(r,"change",this.render)},render:function(){this.render_chart()},render_chart:function(){var e,t,i=this.get_series_options,n=this.get_yaxis_options,s=a.get_now_time_by_ms();t="24h"===r.get("boundary_time")?864e5:6048e5,e=s-t;var o=this.get_default_options(a.get("mts_start"),a.get("mts_end"));$.getJSON(UrlMaker.make("date_histogram",current_conf),{time_interval:"1m",mts_start:e,mts_end:s},function(e){if(e.error_message)return void $("#chart-status").html("<div>"+gettext("获取系统最新状态数据失败")+", "+e.error_message+"</div>");var t=e.data;if(!t)return void $("#chart-status").html("<div>"+gettext("系统最新状态数据为空")+"</div>");var s=_.extend(o,n(!0,!0,!1),i(t)),r=echarts.init(document.getElementById("chart-status"));r.setOption(s),r.on("datazoom",function(e){s=r.getOption(),start_value=s.dataZoom[0].startValue,end_value=s.dataZoom[0].endValue,a.set({time_since:"custom:"+start_value+"_"+end_value,mts_start:start_value,mts_end:end_value})}),r.on("legendselectchanged",function(e){var t=e.selected[gettext("可用率")],i=e.selected[gettext("请求数")],a=e.selected[gettext("平均响应时间")]||e.selected[gettext("统计响应时间")];i&&(a=!1),this.setOption(n(t,i,a))})})},get_default_options:function(e,t){return{title:{text:a.get("system_label")+" "+gettext("系统实时概况"),left:"center",textStyle:{fontWeight:"bold"}},xAxis:[{type:"time",splitLine:{show:!1}}],legend:{orient:"vertical",right:120,top:80,borderWidth:0,selected:{"平均响应时间":!1,"Average response time":!1},textStyle:{fontWeight:"bold"},data:[{name:gettext("可用率")},{name:gettext("请求数")},{name:gettext("平均响应时间")},{name:gettext("统计响应时间")}]},dataZoom:[{type:"slider",xAxisIndex:0,filterMode:"filter",startValue:parseInt(e),endValue:parseInt(t),realtime:!1}],tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(e){var t=[],i=null;return _.each(e,function(e,n){e.value&&(i||(i=moment(e.value[0]).format("YYYY-MM-DD HH:mm"),t.push(i)),null!=e.value[1]&&(e.seriesName==gettext("可用率")?t.push(e.seriesName+": "+e.value[1].toFixed(2)+" %"):e.seriesName==gettext("平均响应时间")||e.seriesName==gettext("统计响应时间")?t.push(e.seriesName+": "+e.value[1].toFixed(2)+" ms"):t.push(e.seriesName+": "+e.value[1])))}),t.join("<br>")}}}},get_yaxis_options:function(e,t,i){return{yAxis:[{max:100,min:"dataMin",scale:!0,position:"left",axisLabel:{formatter:function(e,t){if(0===t){var i=/([0-9]+.[0-9]{2})[0-9]*/;e=e.toString().replace(i,"$1")}return e+"%"},show:e},axisTick:{show:e},axisLine:{show:!1},splitLine:{show:!1}},{position:"right",min:0,minInterval:1,axisLabel:{show:t},axisTick:{show:t},axisLine:{show:!1},splitLine:{show:!1}},{min:0,axisLabel:{formatter:"{value}ms",show:i},axisTick:{show:i},axisLine:{show:!1},splitLine:{show:!1}}]}},get_series_options:function(e){return{series:[{name:gettext("可用率"),type:"line",position:"left",yAxisIndex:0,data:e.rate_availability.data,symbol:"circle",symbolSize:10,showSymbol:!1,lineStyle:{normal:{width:3}},itemStyle:{normal:{color:"#90ed7d"}}},{name:gettext("请求数"),type:"line",yAxisIndex:1,data:e.requests.data,showSymbol:!1,symbol:"diamond",symbolSize:10,lineStyle:{normal:{width:3}},itemStyle:{normal:{color:"#7cb5ec"}}},{name:gettext("平均响应时间"),type:"line",data:e.avg_resp_time.data,yAxisIndex:2,showSymbol:!1,symbol:"rect",symbolSize:10,connectNulls:!0,lineStyle:{normal:{width:3}},itemStyle:{normal:{color:"#434348"}}},{name:gettext("统计响应时间"),type:"line",data:e.perc95_resp_time.data,yAxisIndex:2,symbol:"triangle",symbolSize:10,showSymbol:!1,connectNulls:!0,lineStyle:{normal:{width:3}},itemStyle:{normal:{color:"#e7711b"}}}]}}}),d=(new c,Backbone.View.extend({initialize:function(){this.listenTo(a,"change",this.render)},render:function(){$.getJSON(UrlMaker.make("summary",current_conf),{time_since:a.get("time_since"),mts_start:a.get("mts_start"),mts_end:a.get("mts_end")},function(e){if(e.error_message)return void $("#container-system-summary").html("<div>"+gettext("获取系统概况数据失败")+", "+e.error_message+"</div>");var t=Handlebars.compile($("#tmpl_system_summary").html());$("#container-system-summary").html(t(e.data)),t=Handlebars.compile($("#tmpl_sider_system_info").html()),$("#container-sider-system-info").html(t(e.data))})}})),u=Backbone.View.extend({el:"#requests-details",events:{"click #tab-details li>a":function(e){e.preventDefault(),o.set({type:$(e.target).data("type")})},"click a.check-error-details":"check_error_details"},type_conf_map:{component:{group_by:"req_component_name",template:Handlebars.compile($("#tmpl_table_details_by_component").html()),group_id:"table-details-component"},url:{group_by:"req_url",template:Handlebars.compile($("#tmpl_table_details_by_url").html()),group_id:"table-details-url"},app:{group_by:"req_app_code",template:Handlebars.compile($("#tmpl_table_details_by_app").html()),group_id:"table-details-app"}},initialize:function(){this.listenTo(o,"change",this.render),this.listenTo(a,"change",this.render)},render:function(){var e=this.$("#container-table-details"),t=o.get("type"),n=this.type_conf_map[t];this.$("#tab-details li").removeClass("active"),this.$('#tab-details a[data-type="'+t+'"]').parent().addClass("active"),$.getJSON(UrlMaker.make("group_by",current_conf),{time_since:a.get("time_since"),mts_start:a.get("mts_start"),mts_end:a.get("mts_end"),group_by:n.group_by,order:o.get("order")},function(t){if(t.error_message)return void e.html("<div>"+gettext("获取请求详情数据失败")+", "+t.error_message+"</div>");e.html(n.template(t)),t.data&&t.data.length>0?sort_list=[[5,0]]:sort_list=[],$("#"+n.group_id).tablesorter({theme:"dropbox",headerTemplate:"{content} {icon}",widthFixed:!0,widgets:["zebra","columns","uitheme"],headers:{2:{sorter:"req_count"}},sortList:sort_list})}),i.navigate("main/?time_since="+a.get("time_since"))},check_error_details:function(e){var t=e.target,i=$(t).data("url")||"",n=$(t).data("app_code")||"",s=$(t).data("component_name")||"";$.getJSON(UrlMaker.make("errors",current_conf),{url:i,app_code:n,component_name:s,mts_start:a.get("mts_start"),mts_end:a.get("mts_end"),size:"200"},function(e){if(e.error_message)return void art.dialog({id:"bktips",title:gettext("提示"),icon:"error",lock:!0,content:'<div class="king-notice-box king-notice-fail"><p class="king-notice-text">'+e.error_message+"</p></div>"});var t=Handlebars.compile($("#tmpl_error_details_popup").html()),a=t({data:e.data,url:i,app_code:n,component_name:s});dialog({title:gettext("错误请求详情"),content:a,width:800,height:500,fixed:!0}).showModal()})}});new m,new d,new u;Backbone.history.start()||a.set(e),$("#autorefresh-switch").click()});