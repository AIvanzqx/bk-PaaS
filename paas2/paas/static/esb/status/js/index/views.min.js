$(function(){Handlebars.registerHelper("render_event",function(e){var t="",s='<span data-toggle="tooltip" title="'+moment(e.mts).format("MM-DD HH:mm")+'" class="time">'+moment(e.mts).fromNow()+"</span>",a=e.basic_info.label||e.basic_info.name;return"availability_restored"===e.type&&(t+='<div class="icon"><i class="brand-success fa fa-check-circle"></i></div>',t+='<div class="info">',t+="<strong><a>"+a+"</a></strong> ",t+=s,t+="<div>",t+=gettext("可用率恢复至 100%"),e.data.msecs_avai_dropped&&(low_available_duration=parseInt(e.data.msecs_avai_dropped/1e3/60),tmp_msg=ngettext("低可用持续时间: <strong> %s 分钟</strong>","低可用持续时间: <strong> %s 分钟</strong>",low_available_duration),tmp_msg=interpolate(tmp_msg,[low_available_duration]),t+=", "+tmp_msg),t+="</div></div>"),"availability_dropped"===e.type&&(t+='<div class="icon"><i class="brand-danger fa fa-exclamation-circle"></i></div>',t+='<div class="info">',t+="<strong><a>"+a+"</a></strong> ",t+=s,t+="<div>"+gettext("可用率下降至")+" <strong>"+e.data.rate_availability.value_str+"%</strong>, "+gettext("调用错误数/总次数")+": <strong>"+e.data.requests.error_count+"/"+e.data.requests.count+"</strong></div></div>"),"errors_occurred"===e.type&&(tmp_msg=ngettext("偶发 %s 次请求错误","偶发 %s 次请求错误",e.data.requests.error_count),tmp_msg=interpolate(tmp_msg,[e.data.requests.error_count]),t+='<div class="icon"><i class="brand-warning fa fa-exclamation-circle"></i></div>',t+='<div class="info">',t+="<strong><a>"+a+"</a></strong> ",t+=s,t+="<div>"+tmp_msg+"</div></div>"),t}),Handlebars.registerHelper("add_commas",function(e){return ReplaceNumberWithCommas(e)}),Handlebars.registerHelper("math_floor",function(e){return Math.floor(e)}),Handlebars.registerHelper("smart_color",function(e){return e<97?"#d9534f":e<100?"#f0c04e":"#5cb85c"});var e=Backbone.Model.extend(),t=new e,s=Backbone.View.extend({el:"body",template:Handlebars.compile($("#tmpl_system_list").html()),template_timeline:Handlebars.compile($("#tmpl_events_timeline").html()),events:{"click #selector-time-since a":function(e){t.set({time_since:$(e.target).attr("value")})},"change #autorefresh-switch":function(e){$(e.target).is(":checked")?this.start_auto_refresh():this.stop_auto_refresh()}},initialize:function(){this.listenTo(t,"change",this.render)},render:function(){this.render_system_list(),this.render_timeline()},render_system_list:function(){var e=t.get("time_since"),s=$('#selector-time-since a[value="'+e+'"]');$("#selector-time-since span.dropdown-text").text(s.text());var a=this.template;$.getJSON(UrlMaker.make("summary_all"),{time_since:e},function(e){$("#container-all-system-list").html(a(e)),$('[data-toggle="tooltip"]').tooltip(),e.error_message&&$("#system-list-block").html('<div class="row mt10"><span style="color: #667366">'+gettext("获取实时运营数据失败")+", "+e.error_message+"</span></div>")})},render_timeline:function(){var e=this.template_timeline;$.getJSON(UrlMaker.make("systems_events_timeline"),{},function(t){$("#container-events-timeline").html(e(t)),$('[data-toggle="tooltip"]').tooltip(),t.error_message&&$("#container-events-timeline").html('<div class="events-list" style="padding-top: 0px"><span style="color: #667366">'+gettext("获取系统错误事件失败")+", "+t.error_message+"</span></div>")})},start_auto_refresh:function(){this.interval_var=setInterval(function(){t.trigger("change")},6e4)},stop_auto_refresh:function(){clearInterval(this.interval_var)}});new s;$(document).on("click",".link-to-system",function(){var e=$(this).data("system-name");window.location.href=UrlMaker.make("systems_index",{system_name:e})+"#main/?time_since=1h"}),$(document).on("click",".event",function(){var e=$(this).data("system-name"),t=$(this).data("mts")-3e5,s=_.min([t+36e5,1e3*moment().unix()]),a="custom:"+t+"_"+s;window.location.href=UrlMaker.make("systems_index",{system_name:e})+"#main/?time_since="+a}),t.set({time_since:"1m"}),$("#autorefresh-switch").click()});